\hypertarget{index_8md_8libmd_8cc_source}{}\doxysection{index.\+md.\+libmd.\+cc}
\label{index_8md_8libmd_8cc_source}\index{libmd-\/src/md/index.md.libmd.cc@{libmd-\/src/md/index.md.libmd.cc}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00001}\mbox{\hyperlink{index_8md_8libmd_8cc_a4384389855e24d346feb2e60f23afb0b_a4384389855e24d346feb2e60f23afb0b}{00001}} \textcolor{preprocessor}{\#define \_\_libmd\_src\_file\_\_}}
\DoxyCodeLine{00002 \textcolor{preprocessor}{\#ifndef libmd\_h}}
\DoxyCodeLine{00003 \textcolor{preprocessor}{\#include "../../libmd.h"}}
\DoxyCodeLine{00004 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00005 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00006}\mbox{\hyperlink{structmd_a9dfeaa20a38920b6f7e5b4221a815ac9_a9dfeaa20a38920b6f7e5b4221a815ac9}{00006}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{void} \mbox{\hyperlink{structmd_a9dfeaa20a38920b6f7e5b4221a815ac9_a9dfeaa20a38920b6f7e5b4221a815ac9}{md<dim>::thread\_index\_stick}}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} i)}
\DoxyCodeLine{00007 \{}
\DoxyCodeLine{00011     memcpy(particles[i].xsk,particles[i].x,dim*\textcolor{keyword}{sizeof}(\mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}}));}
\DoxyCodeLine{00012 \}}
\DoxyCodeLine{00013 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00014}\mbox{\hyperlink{structmd_a1ecf37a44dfa7401593a05b4aaed7d68_a1ecf37a44dfa7401593a05b4aaed7d68}{00014}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{void} \mbox{\hyperlink{structmd_a1ecf37a44dfa7401593a05b4aaed7d68_a1ecf37a44dfa7401593a05b4aaed7d68}{md<dim>::index}}()}
\DoxyCodeLine{00015 \{}
\DoxyCodeLine{00021     \textcolor{keywordflow}{for}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} i=0;i<N;i++) thread\_index\_stick(i);}
\DoxyCodeLine{00022     \textcolor{keywordflow}{switch}(indexdata.method)}
\DoxyCodeLine{00023     \{}
\DoxyCodeLine{00024         \textcolor{keywordflow}{case} \mbox{\hyperlink{struct_i_n_d_e_x_a4ee2ed52ee6dd3e482fc53a8db54065f_a4ee2ed52ee6dd3e482fc53a8db54065fa1b389b04cffcf182a4e4434b1ed1e8b8}{INDEX::BRUTE\_FORCE}}:}
\DoxyCodeLine{00025             bruteforce();}
\DoxyCodeLine{00026         \textcolor{keywordflow}{break};}
\DoxyCodeLine{00027         \textcolor{keywordflow}{case} \mbox{\hyperlink{struct_i_n_d_e_x_a4ee2ed52ee6dd3e482fc53a8db54065f_a4ee2ed52ee6dd3e482fc53a8db54065fa29d1bce3f3830b4b695c1bf27f7f6529}{INDEX::KD\_TREE}}:}
\DoxyCodeLine{00028             kdtree();}
\DoxyCodeLine{00029         \textcolor{keywordflow}{break};}
\DoxyCodeLine{00030         \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00031             cell();}
\DoxyCodeLine{00032         \textcolor{keywordflow}{break};}
\DoxyCodeLine{00033     \}}
\DoxyCodeLine{00034     avars.reindex=\textcolor{keyword}{false};}
\DoxyCodeLine{00035 \}}
\DoxyCodeLine{00036 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00037}\mbox{\hyperlink{structmd_aee6148340ce4331e84344df87f4e1800_aee6148340ce4331e84344df87f4e1800}{00037}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{bool} \mbox{\hyperlink{structmd_aee6148340ce4331e84344df87f4e1800_aee6148340ce4331e84344df87f4e1800}{md<dim>::test\_index}}()}
\DoxyCodeLine{00038 \{}
\DoxyCodeLine{00045     \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} rcomax=0.0;}
\DoxyCodeLine{00046     \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} itype:network.library) rcomax=std::max(rcomax,itype.rco);}
\DoxyCodeLine{00047     \textcolor{keyword}{const} \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} delta=\mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(network.ssz-\/rcomax,2)/4.0;}
\DoxyCodeLine{00048     \textcolor{keywordflow}{for}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} i=0;i<N;i++)}
\DoxyCodeLine{00049     \{}
\DoxyCodeLine{00050         \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} test=0.0;}
\DoxyCodeLine{00051         \textcolor{keywordflow}{for}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} d=0;d<dim;d++) test+=\mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(dap(d,particles[i].xsk[d]-\/particles[i].x[d]),2);}
\DoxyCodeLine{00052         \textcolor{keywordflow}{if}(test>delta) \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{00053     \}}
\DoxyCodeLine{00054     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{00055 \}}
\DoxyCodeLine{00056 }
\DoxyCodeLine{00057 \textcolor{comment}{/*** k-\/d tree ***/}}
\DoxyCodeLine{00058 }
\DoxyCodeLine{00059 \textcolor{comment}{// Returns the index of the median}}
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00060}\mbox{\hyperlink{structmd_a8ab281a337c8448f30b808ef51be99e6_a8ab281a337c8448f30b808ef51be99e6}{00060}} \textcolor{keyword}{template}<ui dim> \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} \mbox{\hyperlink{structmd_a8ab281a337c8448f30b808ef51be99e6_a8ab281a337c8448f30b808ef51be99e6}{md<dim>::kdtree\_build}} (\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} first, \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} last, \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} level)}
\DoxyCodeLine{00061 \{   }
\DoxyCodeLine{00062     \textcolor{keywordflow}{if} (last -\/ first == 1) \textcolor{comment}{// Leaf}}
\DoxyCodeLine{00070     \{   \textcolor{comment}{// Set minimum and maximum value equal to the position of this particle (Idx[first])}}
\DoxyCodeLine{00071         memcpy(indexdata.kdtreedata.Pmin[first], particles[indexdata.kdtreedata.Idx[first]].x, dim*\textcolor{keyword}{sizeof}(\mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}}));}
\DoxyCodeLine{00072         memcpy(indexdata.kdtreedata.Pmax[first], particles[indexdata.kdtreedata.Idx[first]].x, dim*\textcolor{keyword}{sizeof}(\mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}}));}
\DoxyCodeLine{00073         \textcolor{keywordflow}{return} first;}
\DoxyCodeLine{00074     \}}
\DoxyCodeLine{00075     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} m = (first+last)/2; \textcolor{comment}{// Median}}
\DoxyCodeLine{00076     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} sortedDim = indexdata.kdtreedata.DivideByDim[level];}
\DoxyCodeLine{00077     \textcolor{comment}{// Put the index of particle with the median value of coordinate dim in its right place,}}
\DoxyCodeLine{00078     \textcolor{comment}{// put all particles with lower values below, and all with higher values above}}
\DoxyCodeLine{00079     std::nth\_element(indexdata.kdtreedata.Idx+first, indexdata.kdtreedata.Idx+m, indexdata.kdtreedata.Idx+last,}
\DoxyCodeLine{00080                 [=](\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} i, \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} j) -\/> \textcolor{keywordtype}{bool} \{ return particles[i].x[sortedDim]<particles[j].x[sortedDim];\});}
\DoxyCodeLine{00081     \textcolor{comment}{// Recursively build subtrees}}
\DoxyCodeLine{00082     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} m1 = kdtree\_build(first, m, level+1), m2 = kdtree\_build(m, last, level+1), d;}
\DoxyCodeLine{00083     \textcolor{comment}{// Determine minimum and maximum value of each coordinate}}
\DoxyCodeLine{00084     \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00085     \{   indexdata.kdtreedata.Pmin[m][d] = std::min(indexdata.kdtreedata.Pmin[m1][d], indexdata.kdtreedata.Pmin[m2][d]);}
\DoxyCodeLine{00086         indexdata.kdtreedata.Pmax[m][d] = std::max(indexdata.kdtreedata.Pmax[m1][d], indexdata.kdtreedata.Pmax[m2][d]);}
\DoxyCodeLine{00087     \}}
\DoxyCodeLine{00088     \textcolor{keywordflow}{return} m;}
\DoxyCodeLine{00089 \}}
\DoxyCodeLine{00090 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00091}\mbox{\hyperlink{structmd_af6fbb4becba7012a1914b5eee637d718_af6fbb4becba7012a1914b5eee637d718}{00091}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{void} \mbox{\hyperlink{structmd_af6fbb4becba7012a1914b5eee637d718_af6fbb4becba7012a1914b5eee637d718}{md<dim>::kdtree\_index}} (\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} first1, \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} last1, \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} first2, \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} last2)}
\DoxyCodeLine{00092 \{}
\DoxyCodeLine{00099     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} m1 = (first1+last1)/2, m2 = (first2+last2)/2, d;}
\DoxyCodeLine{00100     \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} sszsq = \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(network.ssz,2);}
\DoxyCodeLine{00101     \textcolor{comment}{// Base cases}}
\DoxyCodeLine{00102     \textcolor{keywordflow}{if} (m1 == first1 || m2 == first2) \textcolor{comment}{// A single particle}}
\DoxyCodeLine{00103     \{   \textcolor{comment}{// Note: the other subtree contains either one or two particles}}
\DoxyCodeLine{00104         \textcolor{keywordflow}{if} (m1 != m2)}
\DoxyCodeLine{00105             skinner(indexdata.kdtreedata.Idx[m1], indexdata.kdtreedata.Idx[m2], sszsq);}
\DoxyCodeLine{00106         \textcolor{keywordflow}{if} (m2 != first2)}
\DoxyCodeLine{00107             skinner(indexdata.kdtreedata.Idx[m1], indexdata.kdtreedata.Idx[first2], sszsq);}
\DoxyCodeLine{00108         \textcolor{keywordflow}{if} (m1 != first1)}
\DoxyCodeLine{00109             skinner(indexdata.kdtreedata.Idx[first1], indexdata.kdtreedata.Idx[m2], sszsq);}
\DoxyCodeLine{00110         \textcolor{keywordflow}{return};}
\DoxyCodeLine{00111     \}}
\DoxyCodeLine{00112     \textcolor{comment}{// Compute distance (squared) between subtrees}}
\DoxyCodeLine{00113     \textcolor{keywordflow}{if} (m1 != m2) \textcolor{comment}{// Note: m1 == m2 iff the subtrees are the same}}
\DoxyCodeLine{00114     \{   \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} dissqBetweenSubtrees = 0;}
\DoxyCodeLine{00115         \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00116         \{   \textcolor{keywordflow}{if} (simbox.bcond[d] == \mbox{\hyperlink{struct_b_c_o_n_d_a565f9cf3347ba75b9bfc64ec12d69946_a565f9cf3347ba75b9bfc64ec12d69946a975aaa41fc29d28d5513e2907b29f1ce}{BCOND::PERIODIC}})}
\DoxyCodeLine{00117             \{   \textcolor{keywordflow}{if} (indexdata.kdtreedata.Pmin[m1][d] > indexdata.kdtreedata.Pmax[m2][d])}
\DoxyCodeLine{00118                     dissqBetweenSubtrees += \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(std::min(indexdata.kdtreedata.Pmin[m1][d] -\/ indexdata.kdtreedata.Pmax[m2][d],}
\DoxyCodeLine{00119                                                     simbox.L[d] + indexdata.kdtreedata.Pmin[m2][d] -\/ indexdata.kdtreedata.Pmax[m1][d]), 2);}
\DoxyCodeLine{00120                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (indexdata.kdtreedata.Pmin[m2][d] > indexdata.kdtreedata.Pmax[m1][d])}
\DoxyCodeLine{00121                     dissqBetweenSubtrees += \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(std::min(indexdata.kdtreedata.Pmin[m2][d] -\/ indexdata.kdtreedata.Pmax[m1][d],}
\DoxyCodeLine{00122                                                     simbox.L[d] + indexdata.kdtreedata.Pmin[m1][d] -\/ indexdata.kdtreedata.Pmax[m2][d]), 2);}
\DoxyCodeLine{00123             \}}
\DoxyCodeLine{00124             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (indexdata.kdtreedata.Pmin[m1][d] > indexdata.kdtreedata.Pmax[m2][d])}
\DoxyCodeLine{00125                 dissqBetweenSubtrees += \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(indexdata.kdtreedata.Pmin[m1][d] -\/ indexdata.kdtreedata.Pmax[m2][d], 2);}
\DoxyCodeLine{00126             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (indexdata.kdtreedata.Pmin[m2][d] > indexdata.kdtreedata.Pmax[m1][d])}
\DoxyCodeLine{00127                 dissqBetweenSubtrees += \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(indexdata.kdtreedata.Pmin[m2][d] -\/ indexdata.kdtreedata.Pmax[m1][d], 2);}
\DoxyCodeLine{00128         \}}
\DoxyCodeLine{00129         \textcolor{keywordflow}{if} (dissqBetweenSubtrees >= sszsq) \textcolor{comment}{// Return if the subtrees are too far apart}}
\DoxyCodeLine{00130             \textcolor{keywordflow}{return};}
\DoxyCodeLine{00131     \}}
\DoxyCodeLine{00132     \textcolor{comment}{// Recursively check subtrees}}
\DoxyCodeLine{00133     kdtree\_index(first1, m1, first2, m2);}
\DoxyCodeLine{00134     kdtree\_index(first1, m1, m2, last2);}
\DoxyCodeLine{00135     \textcolor{keywordflow}{if} (m1 != m2)}
\DoxyCodeLine{00136         kdtree\_index(m1, last1, first2, m2);}
\DoxyCodeLine{00137     kdtree\_index(m1, last1, m2, last2);}
\DoxyCodeLine{00138 \}}
\DoxyCodeLine{00139 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00140}\mbox{\hyperlink{structmd_a7a10193ac507980720263dd95d259958_a7a10193ac507980720263dd95d259958}{00140}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{void} \mbox{\hyperlink{structmd_a7a10193ac507980720263dd95d259958_a7a10193ac507980720263dd95d259958}{md<dim>::kdtree}}()}
\DoxyCodeLine{00141 \{   }
\DoxyCodeLine{00142     \textcolor{keywordflow}{if} (simbox.useLshear)}
\DoxyCodeLine{00147         \textcolor{keywordflow}{for} (\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} d = 0; d < dim; d++)}
\DoxyCodeLine{00148             \textcolor{keywordflow}{if} (simbox.bcond[d] == \mbox{\hyperlink{struct_b_c_o_n_d_a565f9cf3347ba75b9bfc64ec12d69946_a565f9cf3347ba75b9bfc64ec12d69946a975aaa41fc29d28d5513e2907b29f1ce}{BCOND::PERIODIC}} || simbox.bcond[d] == \mbox{\hyperlink{struct_b_c_o_n_d_a565f9cf3347ba75b9bfc64ec12d69946_a565f9cf3347ba75b9bfc64ec12d69946ae60ceea4da62257e104c5ac6aa720a31}{BCOND::BOXSHEAR}})}
\DoxyCodeLine{00149             \{   \mbox{\hyperlink{macros_8libmd_8h_a4d48c340b3c83579a8d58cb20a320f84_a4d48c340b3c83579a8d58cb20a320f84}{ERROR}}(\textcolor{stringliteral}{"the kd-\/tree algorithm does not work with both shear and periodic boundary conditions"});}
\DoxyCodeLine{00150                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{00151             \}}
\DoxyCodeLine{00152     \textcolor{keywordflow}{if} (indexdata.kdtreedata.Idx == \textcolor{keyword}{nullptr} || \textcolor{keyword}{sizeof}(indexdata.kdtreedata.Idx) != N*\textcolor{keyword}{sizeof}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}}))}
\DoxyCodeLine{00153     \{   \textcolor{keyword}{delete}[] indexdata.kdtreedata.Idx;}
\DoxyCodeLine{00154         \textcolor{keyword}{delete}[] indexdata.kdtreedata.Pmin;}
\DoxyCodeLine{00155         \textcolor{keyword}{delete}[] indexdata.kdtreedata.Pmax;}
\DoxyCodeLine{00156         indexdata.kdtreedata.Idx = \textcolor{keyword}{new} \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}}[N];}
\DoxyCodeLine{00157         indexdata.kdtreedata.Pmin = \textcolor{keyword}{new} \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}}[N][dim];}
\DoxyCodeLine{00158         indexdata.kdtreedata.Pmax = \textcolor{keyword}{new} \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}}[N][dim];}
\DoxyCodeLine{00159     \}}
\DoxyCodeLine{00160     \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} S[dim];}
\DoxyCodeLine{00161     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} i, n, d, b;}
\DoxyCodeLine{00162     \textcolor{keywordflow}{for} (i = 0; i < N; i++)}
\DoxyCodeLine{00163         indexdata.kdtreedata.Idx[i] = i;}
\DoxyCodeLine{00164     \textcolor{comment}{// Decide on which dimensions to divide the particles by at each recursion level}}
\DoxyCodeLine{00165     memcpy(S, simbox.L, \textcolor{keyword}{sizeof}(S));}
\DoxyCodeLine{00166     \textcolor{keywordflow}{for} (i = 0, n = N; n > 1; i++, n = (n+1)/2)}
\DoxyCodeLine{00167     \{   \textcolor{comment}{// Look for largest dimension}}
\DoxyCodeLine{00168         b = 0;}
\DoxyCodeLine{00169         \textcolor{keywordflow}{for} (d = 1; d < dim; d++)}
\DoxyCodeLine{00170             \textcolor{keywordflow}{if} (S[b] < S[d])}
\DoxyCodeLine{00171                 b = d;}
\DoxyCodeLine{00172         indexdata.kdtreedata.DivideByDim[i] = b;}
\DoxyCodeLine{00173         S[b] /= 2; \textcolor{comment}{// Assume that the system is nicely split into two parts}}
\DoxyCodeLine{00174     \}}
\DoxyCodeLine{00175     kdtree\_build(0, N, 0);}
\DoxyCodeLine{00176     \textcolor{keywordflow}{for} (i = 0; i < N; i++)}
\DoxyCodeLine{00177         network.skins[i].clear();}
\DoxyCodeLine{00178     kdtree\_index(0, N, 0, N);}
\DoxyCodeLine{00179 \}}
\DoxyCodeLine{00180 }
\DoxyCodeLine{00181 \textcolor{comment}{/*** Cell algorithm ***/}}
\DoxyCodeLine{00182 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00183}\mbox{\hyperlink{structmd_a32d3e55bfbbebfbc73f0aca3242d8b3b_a32d3e55bfbbebfbc73f0aca3242d8b3b}{00183}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{void} \mbox{\hyperlink{structmd_a32d3e55bfbbebfbc73f0aca3242d8b3b_a32d3e55bfbbebfbc73f0aca3242d8b3b}{md<dim>::thread\_cell}} (\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} c)}
\DoxyCodeLine{00184 \{}
\DoxyCodeLine{00189     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} nNeighbors; \textcolor{comment}{// Number of neighbors of a cell}}
\DoxyCodeLine{00190     \textcolor{keywordtype}{int} CellIndices[dim]; \textcolor{comment}{// Indices (0 to Q[d]) of cell}}
\DoxyCodeLine{00191     \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} DissqToEdge[dim][3]; \textcolor{comment}{// Distance squared from particle to cell edges}}
\DoxyCodeLine{00192     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} NeighboringCells[indexdata.celldata.totNeighbors]; \textcolor{comment}{// Cells to check (accounting for boundary conditions)}}
\DoxyCodeLine{00193     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} NeighborIndex[indexdata.celldata.totNeighbors]; \textcolor{comment}{// Index (0 to totNeighbors) of neighboring cell}}
\DoxyCodeLine{00194     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} d, i, j, k, p1, cellId;}
\DoxyCodeLine{00195     \textcolor{keywordtype}{int} ci;}
\DoxyCodeLine{00196     \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} dissqToCorner, sszsq = \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(network.ssz,2);}
\DoxyCodeLine{00197 }
\DoxyCodeLine{00198     \textcolor{comment}{// Determine cell indices}}
\DoxyCodeLine{00199     k = c;}
\DoxyCodeLine{00200     \textcolor{keywordflow}{for} (d = dim-\/1; d < \mbox{\hyperlink{libmd_8h_a027c70e4468b8d7fb673dec474df6902_a027c70e4468b8d7fb673dec474df6902}{UI\_MAX}}; d-\/-\/)}
\DoxyCodeLine{00201     \{   \mbox{\hyperlink{macros_8libmd_8h_afefca75c5eec58a9b2f18b25a8b649b5_afefca75c5eec58a9b2f18b25a8b649b5}{DEBUG\_3}}(\textcolor{stringliteral}{"indexdata.celldata.Q["} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{"]= "} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{""}, d, indexdata.celldata.Q[d]);}
\DoxyCodeLine{00202         CellIndices[d] = k \% indexdata.celldata.Q[d];}
\DoxyCodeLine{00203         k /= indexdata.celldata.Q[d];}
\DoxyCodeLine{00204     \}}
\DoxyCodeLine{00205 }
\DoxyCodeLine{00206     \textcolor{comment}{// Determine all neighbors}}
\DoxyCodeLine{00207     nNeighbors = 0;}
\DoxyCodeLine{00208     \textcolor{keywordflow}{for} (k = 0; k < indexdata.celldata.totNeighbors; k++)}
\DoxyCodeLine{00209     \{   cellId = 0;}
\DoxyCodeLine{00210         \textcolor{keywordflow}{for} (d = 0; d < dim \&\& (((ci = CellIndices[d]+indexdata.celldata.IndexDelta[k][d]) < (\textcolor{keywordtype}{int})indexdata.celldata.Q[d] \&\& ci >= 0)}
\DoxyCodeLine{00211                                 || ((simbox.bcond[d] == \mbox{\hyperlink{struct_b_c_o_n_d_a565f9cf3347ba75b9bfc64ec12d69946_a565f9cf3347ba75b9bfc64ec12d69946a975aaa41fc29d28d5513e2907b29f1ce}{BCOND::PERIODIC}} || simbox.bcond[d] == \mbox{\hyperlink{struct_b_c_o_n_d_a565f9cf3347ba75b9bfc64ec12d69946_a565f9cf3347ba75b9bfc64ec12d69946ae60ceea4da62257e104c5ac6aa720a31}{BCOND::BOXSHEAR}}) \&\& indexdata.celldata.Q[d] != 2)); d++)}
\DoxyCodeLine{00212             cellId = indexdata.celldata.Q[d] * cellId + (indexdata.celldata.Q[d] + ci) \% indexdata.celldata.Q[d];}
\DoxyCodeLine{00213         \textcolor{keywordflow}{if} (d == dim)}
\DoxyCodeLine{00214         \{   NeighboringCells[nNeighbors] = cellId;}
\DoxyCodeLine{00215             NeighborIndex[nNeighbors] = k;}
\DoxyCodeLine{00216             nNeighbors++;}
\DoxyCodeLine{00217         \}}
\DoxyCodeLine{00218     \}}
\DoxyCodeLine{00219 }
\DoxyCodeLine{00220     \textcolor{comment}{// Loop over all particles in this cell}}
\DoxyCodeLine{00221     \textcolor{keywordflow}{for} (i = indexdata.celldata.Cells[c].size()-\/1; i < \mbox{\hyperlink{libmd_8h_a027c70e4468b8d7fb673dec474df6902_a027c70e4468b8d7fb673dec474df6902}{UI\_MAX}}; i-\/-\/)}
\DoxyCodeLine{00222     \{   p1 = indexdata.celldata.Cells[c][i];}
\DoxyCodeLine{00223 }
\DoxyCodeLine{00224         \textcolor{comment}{// Loop over all remaining particles in the same cell}}
\DoxyCodeLine{00225         \textcolor{keywordflow}{for} (j = i-\/1; j < \mbox{\hyperlink{libmd_8h_a027c70e4468b8d7fb673dec474df6902_a027c70e4468b8d7fb673dec474df6902}{UI\_MAX}}; j-\/-\/)}
\DoxyCodeLine{00226             skinner(p1, indexdata.celldata.Cells[c][j], sszsq);}
\DoxyCodeLine{00227 }
\DoxyCodeLine{00228         \textcolor{keywordflow}{if} (simbox.useLshear || indexdata.celldata.OutsideBox[i])}
\DoxyCodeLine{00229         \{   \textcolor{comment}{// Loop over neighboring cells}}
\DoxyCodeLine{00230             \textcolor{keywordflow}{for} (k = 0; k < nNeighbors; k++)}
\DoxyCodeLine{00231             \{   \textcolor{comment}{// Check all particles in cell}}
\DoxyCodeLine{00232                 \textcolor{keywordflow}{for} (\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} p2 : indexdata.celldata.Cells[NeighboringCells[k]])}
\DoxyCodeLine{00233                     skinner(p1, p2, sszsq);}
\DoxyCodeLine{00234             \}}
\DoxyCodeLine{00235         \}}
\DoxyCodeLine{00236         \textcolor{keywordflow}{else}}
\DoxyCodeLine{00237         \{   \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00238             \{   DissqToEdge[d][1] = 0;}
\DoxyCodeLine{00239                 \textcolor{keywordflow}{if} (indexdata.celldata.Q[d] == 2 \&\& (simbox.bcond[d] == \mbox{\hyperlink{struct_b_c_o_n_d_a565f9cf3347ba75b9bfc64ec12d69946_a565f9cf3347ba75b9bfc64ec12d69946a975aaa41fc29d28d5513e2907b29f1ce}{BCOND::PERIODIC}} || simbox.bcond[d] == \mbox{\hyperlink{struct_b_c_o_n_d_a565f9cf3347ba75b9bfc64ec12d69946_a565f9cf3347ba75b9bfc64ec12d69946ae60ceea4da62257e104c5ac6aa720a31}{BCOND::BOXSHEAR}})) \textcolor{comment}{// Special case: two cells and pbc}}
\DoxyCodeLine{00240                     DissqToEdge[d][0] = DissqToEdge[d][2] = \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(indexdata.celldata.CellSize[d]/2 -\/ \mbox{\hyperlink{autodiff_8libmd_8cc_aef1f4db2bbc91c997fdc24226ea63d52_aef1f4db2bbc91c997fdc24226ea63d52}{std::abs}}((CellIndices[d]+.5) * indexdata.celldata.CellSize[d] -\/ simbox.L[d]/2 -\/ particles[p1].x[d]), 2);}
\DoxyCodeLine{00241                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{00242                 \{   DissqToEdge[d][0] = \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(simbox.L[d]/2 + particles[p1].x[d] -\/ CellIndices[d] * indexdata.celldata.CellSize[d], 2);}
\DoxyCodeLine{00243                     DissqToEdge[d][2] = \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}((CellIndices[d]+1) * indexdata.celldata.CellSize[d] -\/ simbox.L[d]/2 -\/ particles[p1].x[d], 2);}
\DoxyCodeLine{00244                 \}}
\DoxyCodeLine{00245             \}}
\DoxyCodeLine{00246 }
\DoxyCodeLine{00247             \textcolor{comment}{// Loop over neighboring cells}}
\DoxyCodeLine{00248             \textcolor{keywordflow}{for} (k = 0; k < nNeighbors; k++)}
\DoxyCodeLine{00249             \{}
\DoxyCodeLine{00250                 \textcolor{comment}{// Calculate distance (squared) to closest corner}}
\DoxyCodeLine{00251                 dissqToCorner = 0;}
\DoxyCodeLine{00252                 \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00253                     dissqToCorner += DissqToEdge[d][indexdata.celldata.IndexDelta[NeighborIndex[k]][d]+1];}
\DoxyCodeLine{00254                 \textcolor{comment}{// Ignore cell if it is more than sszsq away}}
\DoxyCodeLine{00255                 if (dissqToCorner < sszsq)}
\DoxyCodeLine{00256                     \textcolor{comment}{// Check all particles in cell}}
\DoxyCodeLine{00257                     \textcolor{keywordflow}{for} (\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} p2 : indexdata.celldata.Cells[NeighboringCells[k]])}
\DoxyCodeLine{00258                         skinner(p1, p2, sszsq);}
\DoxyCodeLine{00259             \}}
\DoxyCodeLine{00260         \}}
\DoxyCodeLine{00261     \}}
\DoxyCodeLine{00262 \}}
\DoxyCodeLine{00263 }
\DoxyCodeLine{00264 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00265}\mbox{\hyperlink{structmd_af99c7ccc16292d4c1cdb07bd0c9ac895_af99c7ccc16292d4c1cdb07bd0c9ac895}{00265}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{void} \mbox{\hyperlink{structmd_af99c7ccc16292d4c1cdb07bd0c9ac895_af99c7ccc16292d4c1cdb07bd0c9ac895}{md<dim>::cell}}()}
\DoxyCodeLine{00266 \{   }
\DoxyCodeLine{00267     \mbox{\hyperlink{macros_8libmd_8h_acbe5e8b99e25562e699538dea76d37fa_acbe5e8b99e25562e699538dea76d37fa}{DEBUG\_2}}(\textcolor{stringliteral}{"exec is here"});}
\DoxyCodeLine{00274     \textcolor{keywordflow}{if} (network.ssz <= 0)}
\DoxyCodeLine{00275     \{   \mbox{\hyperlink{macros_8libmd_8h_a4d48c340b3c83579a8d58cb20a320f84_a4d48c340b3c83579a8d58cb20a320f84}{ERROR}}(\textcolor{stringliteral}{"skinsize is not positive (network.ssz = "} \mbox{\hyperlink{libmd_8h_aeae5d38344bd9746908a939e55a8442e_aeae5d38344bd9746908a939e55a8442e}{F\_LDF}} \textcolor{stringliteral}{")"}, network.ssz);}
\DoxyCodeLine{00276         \textcolor{keywordflow}{return};}
\DoxyCodeLine{00277     \}}
\DoxyCodeLine{00278     \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} c, d, i, k, cellId;}
\DoxyCodeLine{00279     \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} x;}
\DoxyCodeLine{00280     std::list<ui>::iterator a, b;}
\DoxyCodeLine{00281     \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} nc = 1;}
\DoxyCodeLine{00282     \textcolor{keywordflow}{if} (simbox.useLshear)}
\DoxyCodeLine{00283     \{   \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} R;}
\DoxyCodeLine{00284         \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00285         \{   R = \mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(dotprod<dim>(simbox.LshearInv[d], simbox.LshearInv[d]), -\/.5);}
\DoxyCodeLine{00286             nc *= indexdata.celldata.Q[d] = (R < network.ssz ? 1 : R/network.ssz);}
\DoxyCodeLine{00287         \}}
\DoxyCodeLine{00288     \}}
\DoxyCodeLine{00289     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00290         \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00291             nc *= indexdata.celldata.Q[d] = (simbox.L[d] < network.ssz ? 1 : simbox.L[d]/network.ssz);}
\DoxyCodeLine{00292     \textcolor{comment}{// If number of cells is very large (ssz very small): reduce until number of cells is in the order of N}}
\DoxyCodeLine{00293     \textcolor{keywordflow}{for} (; nc > N; nc /= 2)}
\DoxyCodeLine{00294     \{}
\DoxyCodeLine{00295         k = 0;}
\DoxyCodeLine{00296         \textcolor{keywordflow}{for} (d = 1; d < dim; d++)}
\DoxyCodeLine{00297             \textcolor{keywordflow}{if} (indexdata.celldata.Q[k] < indexdata.celldata.Q[d])}
\DoxyCodeLine{00298                 k = d;}
\DoxyCodeLine{00299         indexdata.celldata.Q[k] = (indexdata.celldata.Q[k]+1)/2;}
\DoxyCodeLine{00300     \}}
\DoxyCodeLine{00301     \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00302         \mbox{\hyperlink{macros_8libmd_8h_afefca75c5eec58a9b2f18b25a8b649b5_afefca75c5eec58a9b2f18b25a8b649b5}{DEBUG\_3}}(\textcolor{stringliteral}{"indexdata.celldata.Q["} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{"] = "} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{" (from "} \mbox{\hyperlink{libmd_8h_aeae5d38344bd9746908a939e55a8442e_aeae5d38344bd9746908a939e55a8442e}{F\_LDF}} \textcolor{stringliteral}{" / "} \mbox{\hyperlink{libmd_8h_aeae5d38344bd9746908a939e55a8442e_aeae5d38344bd9746908a939e55a8442e}{F\_LDF}} \textcolor{stringliteral}{" originally)"}, d, indexdata.celldata.Q[d], simbox.L[d], network.ssz);}
\DoxyCodeLine{00303     \textcolor{comment}{// Compute and check cell sizes}}
\DoxyCodeLine{00304     \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00305         indexdata.celldata.CellSize[d] = simbox.L[d]/indexdata.celldata.Q[d];}
\DoxyCodeLine{00306 }
\DoxyCodeLine{00307     \textcolor{comment}{// Compute nCells and totNeighbors}}
\DoxyCodeLine{00308     indexdata.celldata.nCells = 1;}
\DoxyCodeLine{00309     indexdata.celldata.totNeighbors = 0;}
\DoxyCodeLine{00310     for (d = 0; d < dim; d++)}
\DoxyCodeLine{00311         \textcolor{keywordflow}{if} (indexdata.celldata.Q[d] > 1) \textcolor{comment}{// Ignore dimensions with only one cell}}
\DoxyCodeLine{00312         \{   indexdata.celldata.nCells *= indexdata.celldata.Q[d];}
\DoxyCodeLine{00313             indexdata.celldata.totNeighbors = 3*indexdata.celldata.totNeighbors+1;}
\DoxyCodeLine{00314         \}}
\DoxyCodeLine{00315 }
\DoxyCodeLine{00316     \textcolor{comment}{// Declare dynamic arrays}}
\DoxyCodeLine{00317     \textcolor{keywordflow}{if} (indexdata.celldata.IndexDelta == \textcolor{keyword}{nullptr} || \textcolor{keyword}{sizeof}(indexdata.celldata.Cells) != indexdata.celldata.nCells*\textcolor{keyword}{sizeof}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}})}
\DoxyCodeLine{00318         || \textcolor{keyword}{sizeof}(indexdata.celldata.IndexDelta) != indexdata.celldata.totNeighbors*dim*\textcolor{keyword}{sizeof}(int)}
\DoxyCodeLine{00319         || \textcolor{keyword}{sizeof}(indexdata.celldata.OutsideBox) != N)}
\DoxyCodeLine{00320     \{   \textcolor{keyword}{delete}[] indexdata.celldata.Cells;}
\DoxyCodeLine{00321         \textcolor{keyword}{delete}[] indexdata.celldata.IndexDelta;}
\DoxyCodeLine{00322         \textcolor{keyword}{delete}[] indexdata.celldata.OutsideBox;}
\DoxyCodeLine{00323         indexdata.celldata.Cells = \textcolor{keyword}{new} std::vector<ui>[indexdata.celldata.nCells];}
\DoxyCodeLine{00324         indexdata.celldata.IndexDelta = \textcolor{keyword}{new} \textcolor{keywordtype}{int}[indexdata.celldata.totNeighbors][dim]; \textcolor{comment}{// Relative position of neighboring cell}}
\DoxyCodeLine{00325         indexdata.celldata.OutsideBox = \textcolor{keyword}{new} \textcolor{keywordtype}{bool}[N];}
\DoxyCodeLine{00326     \}}
\DoxyCodeLine{00327     \textcolor{comment}{// Determine all (potential) neighbors}}
\DoxyCodeLine{00328     \textcolor{comment}{// Start with \{0,0,...,0,+1\}}}
\DoxyCodeLine{00329     \textcolor{keywordflow}{if} (indexdata.celldata.totNeighbors > 0)}
\DoxyCodeLine{00330     \{   memset(indexdata.celldata.IndexDelta[0], 0, dim*\textcolor{keyword}{sizeof}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}}));}
\DoxyCodeLine{00331         \textcolor{keywordflow}{for} (d = dim-\/1; indexdata.celldata.Q[d] == 1; d-\/-\/);}
\DoxyCodeLine{00332         indexdata.celldata.IndexDelta[0][d] = 1;}
\DoxyCodeLine{00333         \textcolor{keywordflow}{for} (i = 1; i < indexdata.celldata.totNeighbors; i++)}
\DoxyCodeLine{00334         \{   memcpy(indexdata.celldata.IndexDelta[i], indexdata.celldata.IndexDelta[i-\/1], dim*\textcolor{keyword}{sizeof}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}}));}
\DoxyCodeLine{00335             \textcolor{comment}{// Set all trailing +1's to -\/1}}
\DoxyCodeLine{00336             \textcolor{keywordflow}{for} (d = dim-\/1; d < dim \&\& (indexdata.celldata.Q[d] == 1 || indexdata.celldata.IndexDelta[i][d] == 1); d-\/-\/)}
\DoxyCodeLine{00337                 \textcolor{keywordflow}{if} (indexdata.celldata.Q[d] > 1)}
\DoxyCodeLine{00338                     indexdata.celldata.IndexDelta[i][d] = -\/1;}
\DoxyCodeLine{00339             \textcolor{comment}{// Increase last not-\/plus-\/one by one}}
\DoxyCodeLine{00340             \textcolor{keywordflow}{if} (d < dim)}
\DoxyCodeLine{00341                 indexdata.celldata.IndexDelta[i][d]++;}
\DoxyCodeLine{00342         \}}
\DoxyCodeLine{00343     \}}
\DoxyCodeLine{00344 }
\DoxyCodeLine{00345     \textcolor{comment}{// Put the particles in their cells}}
\DoxyCodeLine{00346     \textcolor{keywordflow}{for} (c = 0; c < indexdata.celldata.nCells; c++)}
\DoxyCodeLine{00347         indexdata.celldata.Cells[c].clear();}
\DoxyCodeLine{00348     \textcolor{keywordflow}{for} (i = 0; i < N; i++)}
\DoxyCodeLine{00349     \{   cellId = 0;}
\DoxyCodeLine{00350         indexdata.celldata.OutsideBox[i] = \textcolor{keyword}{false};}
\DoxyCodeLine{00351         \textcolor{keywordflow}{for} (d = 0; d < dim; d++)}
\DoxyCodeLine{00352         \{   x = (simbox.useLshear ? dotprod<dim>(simbox.LshearInv[d], particles[i].x) : particles[i].x[d] / simbox.L[d]);}
\DoxyCodeLine{00353             \textcolor{keywordflow}{if} (\mbox{\hyperlink{autodiff_8libmd_8cc_aef1f4db2bbc91c997fdc24226ea63d52_aef1f4db2bbc91c997fdc24226ea63d52}{std::abs}}(x) > .5+1e-\/9)}
\DoxyCodeLine{00354             \{   indexdata.celldata.OutsideBox[i] = \textcolor{keyword}{true};}
\DoxyCodeLine{00355                 cellId = indexdata.celldata.Q[d] * cellId + (x < 0 ? 0 : indexdata.celldata.Q[d]-\/1);}
\DoxyCodeLine{00356             \}}
\DoxyCodeLine{00357             \textcolor{keywordflow}{else}}
\DoxyCodeLine{00358                 cellId = indexdata.celldata.Q[d] * cellId + (x < -\/.5+3e-\/9 ? 0 : (\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}})(indexdata.celldata.Q[d]*(x+.5-\/2e-\/9)));}
\DoxyCodeLine{00359         \}}
\DoxyCodeLine{00360         indexdata.celldata.Cells[cellId].push\_back(i);}
\DoxyCodeLine{00361     \}}
\DoxyCodeLine{00362 }
\DoxyCodeLine{00363     \textcolor{keywordflow}{for} (i = 0; i < N; i++)}
\DoxyCodeLine{00364         network.skins[i].clear();}
\DoxyCodeLine{00365 }
\DoxyCodeLine{00366     \textcolor{keywordflow}{for}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} c=0;c<indexdata.celldata.nCells;c++) thread\_cell(c);}
\DoxyCodeLine{00367 \}}
\DoxyCodeLine{00368 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00369}\mbox{\hyperlink{structmd_a32c3d5e5fe53203d0754ac9706bd0f21_a32c3d5e5fe53203d0754ac9706bd0f21}{00369}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{void} \mbox{\hyperlink{structmd_a32c3d5e5fe53203d0754ac9706bd0f21_a32c3d5e5fe53203d0754ac9706bd0f21}{md<dim>::bruteforce}}()}
\DoxyCodeLine{00370 \{}
\DoxyCodeLine{00376     \mbox{\hyperlink{macros_8libmd_8h_acbe5e8b99e25562e699538dea76d37fa_acbe5e8b99e25562e699538dea76d37fa}{DEBUG\_2}}(\textcolor{stringliteral}{"exec is here"});}
\DoxyCodeLine{00377     \textcolor{keywordflow}{for}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} i=0;i<N;i++) network.skins[i].clear();}
\DoxyCodeLine{00378     \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} sszsq=\mbox{\hyperlink{autodiff_8libmd_8cc_a4fd9e414f0c7ab2098dcea6c6de318d9_a4fd9e414f0c7ab2098dcea6c6de318d9}{std::pow}}(network.ssz,2);}
\DoxyCodeLine{00379     \textcolor{keywordflow}{for}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} i=0;i<N;i++) \textcolor{keywordflow}{for}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} j=i+1;j<N;j++) skinner(i, j, sszsq);}
\DoxyCodeLine{00380 \}}
\DoxyCodeLine{00381 }
\DoxyCodeLine{\Hypertarget{index_8md_8libmd_8cc_source_l00382}\mbox{\hyperlink{structmd_af4e3c55b8f17dfb069af504e6a2c750c_af4e3c55b8f17dfb069af504e6a2c750c}{00382}} \textcolor{keyword}{template}<ui dim> \textcolor{keywordtype}{void} \mbox{\hyperlink{structmd_af4e3c55b8f17dfb069af504e6a2c750c_af4e3c55b8f17dfb069af504e6a2c750c}{md<dim>::skinner}}(\mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} i, \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} j, \mbox{\hyperlink{libmd_8h_a9b1cd8bf0a06d4a62c19f7953a3487ea_a9b1cd8bf0a06d4a62c19f7953a3487ea}{ldf}} sszsq)}
\DoxyCodeLine{00383 \{}
\DoxyCodeLine{00389     \textcolor{keywordflow}{if} (distsq(i,j) > sszsq)}
\DoxyCodeLine{00390         \textcolor{keywordflow}{return};}
\DoxyCodeLine{00391     \textcolor{keyword}{const} \mbox{\hyperlink{libmd_8h_aa0f39ee33b87675e11229913d432ffe7_aa0f39ee33b87675e11229913d432ffe7}{ui}} K=network.spid[i];}
\DoxyCodeLine{00392     std::pair<ui,ui> it;}
\DoxyCodeLine{00393     \textcolor{keywordflow}{if}(K<\mbox{\hyperlink{libmd_8h_a027c70e4468b8d7fb673dec474df6902_a027c70e4468b8d7fb673dec474df6902}{UI\_MAX}} and K==network.spid[j] and network.sptypes[network.superparticles[K].sptype].splookup.count(it=network.hash(network.superparticles[K].particles[i],network.superparticles[K].particles[j])))}
\DoxyCodeLine{00394     \{}
\DoxyCodeLine{00395         \mbox{\hyperlink{structinteractionneighbor}{interactionneighbor}} in(j,network.sptypes[network.superparticles[K].sptype].splookup[it]);}
\DoxyCodeLine{00396         network.skins[i].push\_back(in);}
\DoxyCodeLine{00397         in.\mbox{\hyperlink{structinteractionneighbor_a8a7a87a5baf3f17681168c65a37f3a71_a8a7a87a5baf3f17681168c65a37f3a71}{neighbor}}=i;}
\DoxyCodeLine{00398         network.skins[j].push\_back(in);}
\DoxyCodeLine{00399         \mbox{\hyperlink{macros_8libmd_8h_afefca75c5eec58a9b2f18b25a8b649b5_afefca75c5eec58a9b2f18b25a8b649b5}{DEBUG\_3}}(\textcolor{stringliteral}{"super particle skinned (i,j)=("} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{","} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{") in "} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{" with interaction "} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{""},i,j,K,network.sptypes[network.superparticles[K].sptype].splookup[it]);}
\DoxyCodeLine{00400     \}}
\DoxyCodeLine{00401     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00402     \{}
\DoxyCodeLine{00403         it=network.hash(particles[i].type,particles[j].type);}
\DoxyCodeLine{00404         \textcolor{keywordflow}{if}(network.lookup.count(it))}
\DoxyCodeLine{00405         \{}
\DoxyCodeLine{00406             \mbox{\hyperlink{structinteractionneighbor}{interactionneighbor}} in(j,network.lookup[it]);}
\DoxyCodeLine{00407             network.skins[i].push\_back(in);}
\DoxyCodeLine{00408             in.\mbox{\hyperlink{structinteractionneighbor_a8a7a87a5baf3f17681168c65a37f3a71_a8a7a87a5baf3f17681168c65a37f3a71}{neighbor}}=i;}
\DoxyCodeLine{00409             network.skins[j].push\_back(in);}
\DoxyCodeLine{00410             \mbox{\hyperlink{macros_8libmd_8h_afefca75c5eec58a9b2f18b25a8b649b5_afefca75c5eec58a9b2f18b25a8b649b5}{DEBUG\_3}}(\textcolor{stringliteral}{"normally skinned (i,j)=("} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{","} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{") with interaction "} \mbox{\hyperlink{libmd_8h_a0912422c5c51b0116165d1714a0a56a7_a0912422c5c51b0116165d1714a0a56a7}{F\_UI}} \textcolor{stringliteral}{""},i,j,network.lookup[it]);}
\DoxyCodeLine{00411         \}}
\DoxyCodeLine{00412     \}}
\DoxyCodeLine{00413 \}}

\end{DoxyCode}
